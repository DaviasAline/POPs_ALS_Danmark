---
title: "Aline's work"
format: html
editor: visual
toc: true
toc_depth: 4
theme:
  light: flatly
  dark: darkly
toc-location: left
---

```{r}
#| message: false
#| warning: false
#| include: false
source("~/Documents/POP_ALS_2025_02_03/1_codes/2.5_analyses_fattyacids_ALS_survival.R")
```

# Danish data description

## ALS survival

```{r}
#| echo: false
#| message: false
#| warning: false
bdd_danish |> 
  filter(als == 1) |>
  ggplot() +
  aes(x = follow_up_death) +
  geom_density(fill = "lightgray") +
  theme_bw() +
  stat_overlay_normal_density(color = "red", linetype = "dashed") +
  theme(axis.title = element_blank())
descrip_num(data = bdd_danish, vars = "follow_up_death") |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

## Metadata

Not imputed for missing data

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$danish$covar_danish |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

## POPs

### Distribution tables

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$danish$POPs_table_danish |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### Comparison of distribution cases/controls

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$danish$POPs_table_danish_by_als|>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### Heatmap of correlation

```{r fig.height=11, fig.width=11}
#| echo: false
#| message: false
#| warning: false
corrplot(results_descriptive$danish$POPs_heatmap_danish, 
         method = 'color', 
         type = "lower", 
         tl.col = 'black', 
         tl.srt = 45, 
         addCoef.col = "black",
         number.cex = 0.8,
         number.digits = 1,
         tl.cex = 1,
         col = rev(COL2(diverging = "RdYlBu")))
```

### Boxplots

```{r, fig.width=10, fig.height=10}
#| echo: false
#| message: false
#| warning: false
# descrip_expo_danish
results_descriptive$danish$POPs_boxplot_danish_by_als
```

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$danish$POPs_group_boxplot_danish_by_als
```

POPs distribution depending on alive/deceased status at the end of the follow-up (among cases)

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$danish$POPs_group_boxplot_danish_by_death
```

### Detailed distribution

#### Summed

```{r}
#| echo: false
#| message: false
#| warning: false
densityplot(data = bdd_danish, vars = POPs_group)
boxplot(data = bdd_danish, vars = POPs_group)
heatmap_cor(cormat = bdd_danish[POPs_group], decimal = 1)
```

#### PCBs

```{r}
#| echo: false
#| message: false
#| warning: false
PCBs <- bdd_danish |> select(all_of(POPs)) |> select(contains("PCB")) |> colnames()
densityplot(data = bdd_danish, vars = PCBs[1:9])
```

```{r, fig.height=3.33}
#| echo: false
#| message: false
#| warning: false
densityplot(data = bdd_danish, vars = PCBs[10:13])
```

```{r}
#| echo: false
#| message: false
#| warning: false
boxplot(data = bdd_danish, vars = PCBs[1:10])
```

```{r, fig.height=2}
#| echo: false
#| message: false
#| warning: false
boxplot(data = bdd_danish, vars = PCBs[11:13])
```

```{r}
#| echo: false
#| message: false
#| warning: false
heatmap_cor(cormat = bdd_danish[PCBs], decimal = 1)
rm(PCBs)
```

#### OCPs

```{r}
#| echo: false
#| message: false
#| warning: false
OCPs <- bdd_danish |> select(all_of(POPs)) |> select(contains("OCP")) |> colnames()
densityplot(data = bdd_danish, vars = OCPs)
boxplot(data = bdd_danish, vars = OCPs)
heatmap_cor(cormat = bdd_danish[OCPs], decimal = 1)
```

#### PBDEs

```{r,  fig.width=7, fig.height=3}
#| echo: false
#| message: false
#| warning: false
PBDEs <- bdd_danish |> select(all_of(POPs)) |> select(contains("PBDE")) |> colnames()
densityplot(data = bdd_danish, vars = PBDEs)
boxplot(data = bdd_danish, vars = PBDEs)
```

```{r,  fig.width=7, fig.height=4}
#| echo: false
#| message: false
#| warning: false
heatmap_cor(cormat = bdd_danish[PBDEs], decimal = 1)
```

## Fatty acids

### Distribution tables

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$danish$fattyacids_table_danish|>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### Comparison of distribution cases/controls

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$danish$fattyacids_table_danish_by_als |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### Heatmap of correlation

```{r, fig.height=12, fig.width=12}
#| echo: false
#| message: false
#| warning: false
corrplot(results_descriptive$danish$fattyacids_heatmap_danish, 
         method = 'color', 
         type = "lower", 
         tl.col = 'black', 
         tl.srt = 45, 
         addCoef.col = "black",
         number.cex = 0.8,
         number.digits = 1,
         tl.cex = 1,
         col = rev(COL2(diverging = "RdYlBu")))
```

### Boxplots

```{r, fig.height=10, fig.width=10}
#| echo: false
#| message: false
#| warning: false
# results_descriptive$danish$fattyacids_boxplot_danish
results_descriptive$danish$fattyacids_boxplot_danish_by_als
```

### Detailed distribution

#### Density plots

```{r, fig.height=10, fig.width=10}
#| echo: false
#| message: false
#| warning: false
bdd_danish |> 
  select(sample, all_of(fattyacids)) |>
  pivot_longer(cols = -sample, names_to = "fattyacids", values_to = "values") |>
  mutate(fattyacids = fct_recode(fattyacids, !!!fattyacids_labels)) |>
  ggplot() +
  aes(x = values) +
  geom_density(fill = "#112446") +
  theme_minimal() +
  facet_wrap(~fattyacids, scales = "free", ncol = 4)
```

## Heatmap POPs/Fatty acids

```{r, fig.width=12, fig.height=12}
#| echo: false
#| message: false
#| warning: false
results_descriptive$danish$POPs_fattyacids_heatmap_danish
```

## Multiple cholesterol variables

```{r, fig.height=5}
#| echo: false
#| message: false
#| warning: false
boxplot(data = bdd_danish, vars = c("fS_Kol", "cholesterol"))
descrip_num(data = bdd_danish, vars = c("fS_Kol", "cholesterol")) |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
cor.test(bdd_danish$fS_Kol, bdd_danish$cholesterol)
```

## Timing between baseline, ALS diagnosis and death

```{r}
#| echo: false
#| message: false
#| warning: false
timing <- bdd |> 
  filter(study == "Danish") |>
  filter(als == 1) |>
  select(baseline_age, diagnosis_age, death_age, 
         time_baseline_diagnosis, time_baseline_death, time_diagnosis_death)

timing |> 
  tbl_summary() |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")

descrip_num(data = timing, vars = colnames(timing))   |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
rm(timing)
```

## Proteomic

### Distribution table

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$danish$proteomic_table_danish  |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### Comparison of distribution cases/controls

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$danish$proteomic_table_danish_by_als|>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### Heatmap of correlation

```{r fig.height=11, fig.width=11}
#| echo: false
#| message: false
#| warning: false
corrplot(results_descriptive$danish$proteomic_heatmap_danish, 
         method = 'color', 
         type = "lower", 
         tl.col = 'black',
         order = "hclust",         # regroupement des variables selon niveau de cor
         tl.srt = 45, 
         # addCoef.col = "black",
         # number.cex = 0.8,
         # number.digits = 1,
         tl.cex = 0.4,             # taille police des variables
         col = rev(COL2(diverging = "RdYlBu")))
```

### Boxplots

```{r, fig.width=10, fig.height=30}
#| echo: false
#| message: false
#| warning: false
results_descriptive$danish$proteomic_boxplot_danish
```

```{r, fig.width=10, fig.height=30}
#| echo: false
#| message: false
#| warning: false
results_descriptive$danish$proteomic_boxplot_danish_by_als
```

POPs distribution depending on alive/deceased status at the end of the follow-up (among cases)

```{r, fig.width=10, fig.height=30}
#| echo: false
#| message: false
#| warning: false
results_descriptive$danish$proteomic_boxplot_danish_by_death
```

# Finnish data description

## ALS survival

```{r}
#| echo: false
#| message: false
#| warning: false
bdd_finnish |> 
  filter(als == 1) |>
  select(follow_up_death, status_death, study) |>
  tbl_summary(by = "study") |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")

densityplot(data = bdd_finnish, vars = "follow_up_death") 
descrip_num(data = bdd_finnish, vars = "follow_up_death") |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

## Metadata

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$finnish$covar_finnish |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

## POPs

### Distribution tables

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$finnish$POPs_table_finnish |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### Comparison of distribution cases/controls

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$finnish$POPs_table_finnish_by_als |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### Heatmap of correlation

```{r fig.height=11, fig.width=11}
#| echo: false
#| message: false
#| warning: false
corrplot(results_descriptive$finnish$POPs_heatmap_finnish, 
         method = 'color', 
         type = "lower", 
         tl.col = 'black', 
         tl.srt = 45, 
         addCoef.col = "black",
         number.cex = 0.8,
         number.digits = 1,
         tl.cex = 1,
         col = rev(COL2(diverging = "RdYlBu")))
```

### Boxplots

```{r, fig.width=10, fig.height=10}
#| echo: false
#| message: false
#| warning: false
# results_descriptive$finnish$POPs_boxplot_finnish
results_descriptive$finnish$POPs_boxplot_finnish_by_als
```

### Detailed distribution

#### Summed

```{r}
#| echo: false
#| message: false
#| warning: false
densityplot(data = bdd_finnish, vars = POPs_group)
boxplot(data = bdd_finnish, vars = POPs_group)
heatmap_cor(cormat = bdd_finnish[POPs_group], decimal = 1)
```

#### PCBs

```{r}
#| echo: false
#| message: false
#| warning: false
PCBs <- bdd_finnish |> select(all_of(POPs_finnish)) |> select(contains("PCB")) |> colnames()
densityplot(data = bdd_finnish, vars = PCBs[1:9])
```

```{r, fig.height=3.33}
#| echo: false
#| message: false
#| warning: false
densityplot(data = bdd_finnish, vars = PCBs[10:13])
```

```{r}
#| echo: false
#| message: false
#| warning: false
boxplot(data = bdd_finnish, vars = PCBs[1:10])
```

```{r, fig.height=2}
#| echo: false
#| message: false
#| warning: false
boxplot(data = bdd_finnish, vars = PCBs[11:13])
```

```{r}
#| echo: false
#| message: false
#| warning: false
heatmap_cor(cormat = bdd_finnish[PCBs], decimal = 1)
rm(PCBs)
```

#### OCPs

```{r}
#| echo: false
#| message: false
#| warning: false
OCPs <- bdd_finnish |> select(all_of(POPs_finnish)) |> select(contains("OCP")) |> colnames()
densityplot(data = bdd_finnish, vars = OCPs)
boxplot(data = bdd_finnish, vars = OCPs)
# heatmap_cor(cormat = bdd_finnish[OCPs], decimal = 1)
```

#### PBDEs

```{r,  fig.width=7, fig.height=3}
#| echo: false
#| message: false
#| warning: false
PBDEs <- bdd_finnish |> select(all_of(POPs_finnish)) |> select(contains("PBDE")) |> colnames()
densityplot(data = bdd_finnish, vars = PBDEs)
boxplot(data = bdd_finnish, vars = PBDEs)
```

```{r,  fig.width=7, fig.height=4}
#| echo: false
#| message: false
#| warning: false
heatmap_cor(cormat = bdd_finnish[PBDEs], decimal = 1)
```

## Fatty acids

### Distribution tables

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$finnish$fattyacids_table_finnish |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### Comparison of distribution cases/controls

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$finnish$fattyacids_table_finnish_by_als |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### Heatmap of correlation

```{r, fig.height=12, fig.width=12}
#| echo: false
#| message: false
#| warning: false
corrplot(results_descriptive$finnish$fattyacids_heatmap_finnish, 
         method = 'color', 
         type = "lower", 
         tl.col = 'black', 
         tl.srt = 45, 
         addCoef.col = "black",
         number.cex = 0.8,
         number.digits = 1,
         tl.cex = 1,
         col = rev(COL2(diverging = "RdYlBu")))
```

### Boxplots

```{r, fig.height=10, fig.width=10}
#| echo: false
#| message: false
#| warning: false
# results_descriptive$finnish$fattyacids_boxplot_finnish
results_descriptive$finnish$fattyacids_boxplot_finnish_by_als
```

### Detailed distribution

```{r, fig.height=10, fig.width=10}
#| echo: false
#| message: false
#| warning: false
bdd_finnish |> 
  select(sample, all_of(fattyacids)) |>
  pivot_longer(cols = -sample, names_to = "fattyacids", values_to = "values") |>
    mutate(fattyacids = fct_recode(fattyacids, !!!fattyacids_labels)) |>
  ggplot() +
  aes(x = "", y = values) +
  geom_boxplot(shape = "circle", fill = "#112446") +
  coord_flip() +
  theme_bw() +
  theme(axis.title = element_blank()) +
  facet_wrap(~fattyacids, scales = "free", ncol = 3L, nrow = 14L)
```

## Heatmap POPs/Fatty acids

```{r, fig.width=12, fig.height=12}
#| echo: false
#| message: false
#| warning: false
results_descriptive$finnish$POPs_fattyacids_heatmap_finnish
```

## Multiple cholesterol variables issue

Why do we have 3 cholesterol variables in the finnish data ?

```{r, fig.height=4}
#| echo: false
#| message: false
#| warning: false
boxplot(data = bdd_finnish, vars = c("fS_Kol", "chol", "cholesterol"))
descrip_num(data = bdd_finnish, vars = c("fS_Kol", "chol", "cholesterol")) |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") 
heatmap_cholesterol <- bdd_finnish |> select("fS_Kol", "chol", "cholesterol")
heatmap_cholesterol <- cor(heatmap_cholesterol, 
                    use = "pairwise.complete.obs", 
                    method = "pearson")

corrplot(heatmap_cholesterol, 
         method = 'color', 
         type = "lower", 
         tl.col = 'black', 
         tl.srt = 45, 
         addCoef.col = "black",
         number.cex = 0.8,
         number.digits = 1,
         tl.cex = 1,
         col = rev(COL2(diverging = "RdYlBu")))

```

## Timing between baseline, ALS diagnosis and death

### FMC

```{r}
#| echo: false
#| message: false
#| warning: false
timing <- bdd |> 
  filter(study == "FMC") |>
  filter(als == 1) |>
  select(baseline_age, diagnosis_age, death_age) |>
  mutate(time_baseline_diagnosis = diagnosis_age - baseline_age, 
         time_baseline_death = death_age - baseline_age, 
         time_diagnosis_death = death_age - diagnosis_age) 

timing |> 
  tbl_summary() |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")

descrip_num(data = timing, vars = colnames(timing)) |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
rm(timing)
```

### FMCF

```{r}
#| echo: false
#| message: false
#| warning: false
timing <- bdd |> 
  filter(study == "FMCF") |>
  filter(als == 1) |>
  select(baseline_age, diagnosis_age, death_age, 
         time_baseline_diagnosis, time_baseline_death, time_diagnosis_death)

timing |> 
  tbl_summary() |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
   set_table_properties(align = "left")|>
  set_table_properties(align = "left")

descrip_num(data = timing, vars = colnames(timing)) |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
rm(timing)
```

### MFH

```{r}
#| echo: false
#| message: false
#| warning: false
timing <- bdd |> 
  filter(study == "MFH") |>
  filter(als == 1) |>
  select(baseline_age, diagnosis_age, death_age, 
         time_baseline_diagnosis, time_baseline_death, time_diagnosis_death)

timing |> 
  tbl_summary() |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")

descrip_num(data = timing, vars = colnames(timing)) |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
rm(timing)
```

# Comparison danish/finnish data

## On the total population

### Metadata

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$comp$covar_comp |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### POPs

```{r, fig.width=10, fig.height=10}
#| echo: false
#| message: false
#| warning: false
results_descriptive$comp$POPs_table_comp |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
results_descriptive$comp$POPs_boxplot_comp
```

### Fatty acids

```{r, fig.height=12, fig.width=12}
#| echo: false
#| message: false
#| warning: false
results_descriptive$comp$fattyacids_table_comp |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
results_descriptive$comp$fattyacids_boxplot_comp 
```

## Among cases

(for ALS survival analyses) \### Metadata

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$comp$covar_comp_cases |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### POPs

```{r}
#| echo: false
#| message: false
#| warning: false
results_descriptive$comp$POPs_table_comp_cases |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")

results_descriptive$comp$POPs_boxplot_comp_cases
```

```{r, fig.width=12, fig.height=12}
#| echo: false
#| message: false
#| warning: false
#| paged-print: false
corrplot(results_descriptive$comp$POPs_heatmap_cases, 
         method = 'color', 
         type = "lower", 
         tl.col = 'black', 
         tl.srt = 45, 
         addCoef.col = "black",
         number.cex = 0.8,
         number.digits = 1,
         tl.cex = 1,
         col = rev(COL2(diverging = "RdYlBu")))
```

# POPs and ALS occurence

## Danish cohort

### Effects of subject characteristics on ALS occurence

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_occurrence$main$covar |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### Effects of POPs on ALS occurence

#### Quartile models

##### Main analysis

In the copollutant models, the pollutant of interest is quartile while the others are s() in a GAM model

```{r fig.height=9, fig.width=9}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_occurrence$main$plot_quart
```

```{r}
#| echo: false
#| message: false
#| warning: false
extra_rows <- results_POPs_ALS_occurrence$main$results_quart |>
  distinct(variable) |> 
  mutate(
    quartiles = "Quartile 1",
    "OR_base" = '-', "95%CI_base" = '-', "p.value_base" = '', "p.value_heterogeneity_base" = '', "p.value_trend_base" = '',
    "OR_adjusted" = '-', "95%CI_adjusted" = '-', "p.value_adjusted" = '', , "p.value_heterogeneity_adjusted" = '', "p.value_trend_adjusted" = '',
    "OR_copollutant" = '-', "95%CI_copollutant" ='-', "p.value_copollutant" = '', , "p.value_heterogeneity_copollutant" = '', "p.value_trend_copollutant" = '')

table_S2 <- 
  results_POPs_ALS_occurrence$main$main_results |>
  select(-lower_CI, -upper_CI, - p.value_raw) |>
  filter(model %in% c('base_quart', 'adjusted_quart', 'copollutant_quart')) |>
  pivot_wider(
    names_from = model,  
    values_from = c(OR, `95%CI`, p.value, p.value_heterogeneity, p.value_trend)) |>
  select(variable, 
         quartiles = df,
         contains("base_quart"), 
         contains("adjusted_quart"), 
         contains("copollutant_quart")) 
colnames(table_S2) <- gsub('_quart', '', colnames(table_S2))

table_S2 <- table_S2 |>
  mutate_if(is.numeric, as.character) |>
  bind_rows(extra_rows) |>
  mutate(
    variable = gsub("OCP_", "", variable), 
    variable = fct_relevel(variable, "PCB_4", "PCB_DL", "PCB_NDL",  "HCB", "ΣDDT", "β_HCH", "Σchlordane", "ΣPBDE" ),
    variable = fct_recode(variable, 
                          "Most prevalent PCBs" = "PCB_4",
                          "Dioxin-like PCBs" = "PCB_DL",
                          "Non-dioxin-like PCBs" = "PCB_NDL",
                          "β-HCH" = "β_HCH")) |>
  arrange(variable, quartiles) |>
  group_by(variable) |>
  mutate(p.value_heterogeneity_base = ifelse(quartiles == 'Quartile 1', p.value_heterogeneity_base[quartiles == 'Quartile 2'], ''), 
         p.value_trend_base = ifelse(quartiles == 'Quartile 1', p.value_trend_base[quartiles == 'Quartile 2'], ''),
         p.value_heterogeneity_adjusted = ifelse(quartiles == 'Quartile 1', p.value_heterogeneity_adjusted[quartiles == 'Quartile 2'], ''), 
         p.value_trend_adjusted = ifelse(quartiles == 'Quartile 1', p.value_trend_adjusted[quartiles == 'Quartile 2'], ''), 
         p.value_heterogeneity_copollutant = ifelse(quartiles == 'Quartile 1', p.value_heterogeneity_copollutant[quartiles == 'Quartile 2'], ''), 
         p.value_trend_copollutant = ifelse(quartiles == 'Quartile 1', p.value_trend_copollutant[quartiles == 'Quartile 2'], '')) |>
  ungroup() |>
  rename('OR' = 'OR_base', '95% CI' = '95%CI_base', 'p-value' = 'p.value_base', 
         'Heterogeneity test' = 'p.value_heterogeneity_base', 'Trend test' = 'p.value_trend_base',
         'OR ' = 'OR_adjusted', '95% CI ' = '95%CI_adjusted', 'p-value ' = 'p.value_adjusted', 
         'Heterogeneity test ' = 'p.value_heterogeneity_adjusted', 'Trend test ' = 'p.value_trend_adjusted',
         ' OR ' = 'OR_copollutant', ' 95% CI ' = '95%CI_copollutant', ' p-value ' = 'p.value_copollutant',
         ' Heterogeneity test ' = 'p.value_heterogeneity_copollutant', ' Trend test ' = 'p.value_trend_copollutant')
table_S2 <- table_S2 |> flextable() |>
  add_footer_lines(
    "1POPs were summed as follows: Dioxin-like PCBs corresponds to PCBs 118 and 156; non-dioxin-like PCBs corresponds to PCBs 28, 52, 74, 99, 101, 138, 153, 170, 180, 183, 187; most prevalent PCBs corresponds to PCBs 118, 138, 153, 180; ΣPBDE corresponds to PBDEs 47, 99, 153; ΣDDT corresponds to p,p’-DDT and p,p’-DDE and finally Σchlordane corresponds to trans-nonanchlor and oxychlordane.
  2All models are matched for sex and age. Adjusted models further account for smoking, BMI, serum total cholesterol, marital status, and education. Co-pollutant models further include all chemicals, where a GAM is used in which the chemical of interest is categorized into quartiles, while the other pollutants are included as smooth terms.
  3Estimated risk of ALS when exposures to POP are at quartiles 2, 3, and 4, compared to quartile 1.
  4CI: Confidence interval.
  5Heterogeneity tests in outcome value across POP quartiles, matched on age and sex.
  6Trend tests using continuous variables whose values corresponded to the quartile specific median POP levels, matched on age and sex.
  7Heterogeneity tests in outcome value across POP quartiles, matched on age and sex, and adjusted for smoking, BMI, serum total cholesterol, marital status, and education.
  8Trend tests using continuous variables whose values corresponded to the quartile specific median POP levels, matched on age and sex, and adjusted for smoking, BMI, serum total cholesterol, marital status, and education.") |>
  add_header(
    "variable" = "Exposures", "quartiles" = "Quartiles",
    "OR" = "Base Model", "95% CI" = "Base Model", "p-value" = "Base Model", "Heterogeneity test" = 'Base Model', "Trend test" = 'Base Model',
    "OR " = "Adjusted Model", "95% CI " = "Adjusted Model", "p-value " = "Adjusted Model", "Heterogeneity test " = 'Adjusted Model', "Trend test " = 'Adjusted Model',
    " OR " = "Co-pollutant model", " 95% CI " = "Co-pollutant model", " p-value " = "Co-pollutant model", " Heterogeneity test " = 'Co-pollutant model', " Trend test " = 'Co-pollutant model') |>
  merge_h(part = "header") |>
  merge_v(j = "variable") |>
  theme_vanilla() |>
  bold(j = "variable", part = "body") |>
  align(align = "center", part = "all") |>
  align(j = "variable", align = "left", part = "all") |> 
  merge_at(j = "variable", part = "header") |>
  merge_at(j = "quartiles", part = "header") |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all")|>
  set_table_properties(align = "left")

table_S2
rm(extra_rows, table_S2)
```

##### q-gcomp analysis

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_occurrence$main$POPs_ALS_qgcomp_table_danish |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
results_POPs_ALS_occurrence$main$POPs_ALS_qgcomp_figure_danish
```

##### Sensitivity analysis POPs not summed

```{r,  fig.height=15, fig.width=10}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_occurrence$sensitivity_not_summed$plot_quart_sensi_not_summed
```

#### GAM models

Relationship between POPs exposure at baseline time and ALS occurrence estimated using a generalized additive model (gam) from the Danish Diet, Cancer and Health study cohort established between December 1993 and May 1997. The solid blue line represents the predicted ALS occurrence by POPs exposure given that all other covariates are at their respective means. The light blue represents the 95% confidence intervals. All models were adjusted for sex and age. Adjusted models further account for serum cholesterol, BMI, smoking status, marital status and education. The effective degrees of freedom (EDF) for the POPs smooth terms is a summary statistic of a gam that reflects the degree of nonlinearity (edf=1: linear, edf=2: quadratic, edf\>2: more complex than quadratic).

##### Main analyses
```{r, fig.height=3.5, fig.width=9}
#| echo: false
#| message: false
#| warning: false
wrap_plots(
  results_POPs_ALS_occurrence$main$plot_base_gam$PCB_DL, 
  results_POPs_ALS_occurrence$main$plot_adjusted_gam$PCB_DL, 
  results_POPs_ALS_occurrence$main$plot_copollutant_gam$PCB_DL, 
  nrow = 1)
wrap_plots(
  results_POPs_ALS_occurrence$main$plot_base_gam$PCB_NDL, 
  results_POPs_ALS_occurrence$main$plot_adjusted_gam$PCB_NDL, 
  results_POPs_ALS_occurrence$main$plot_copollutant_gam$PCB_NDL, 
  nrow = 1)
wrap_plots(
  results_POPs_ALS_occurrence$main$plot_base_gam$PCB_4, 
  results_POPs_ALS_occurrence$main$plot_adjusted_gam$PCB_4,  
  wrap_elements(grid::nullGrob()),
  nrow = 1)
wrap_plots(
  results_POPs_ALS_occurrence$main$plot_base_gam$OCP_HCB, 
  results_POPs_ALS_occurrence$main$plot_adjusted_gam$OCP_HCB, 
  results_POPs_ALS_occurrence$main$plot_copollutant_gam$OCP_HCB, 
  nrow = 1)
wrap_plots(
  results_POPs_ALS_occurrence$main$plot_base_gam$ΣDDT, 
  results_POPs_ALS_occurrence$main$plot_adjusted_gam$ΣDDT, 
  results_POPs_ALS_occurrence$main$plot_copollutant_gam$ΣDDT, 
  nrow = 1)
wrap_plots(
  results_POPs_ALS_occurrence$main$plot_base_gam$OCP_β_HCH, 
  results_POPs_ALS_occurrence$main$plot_adjusted_gam$OCP_β_HCH, 
  results_POPs_ALS_occurrence$main$plot_copollutant_gam$OCP_β_HCH, 
  nrow = 1)
wrap_plots(
  results_POPs_ALS_occurrence$main$plot_base_gam$Σchlordane, 
  results_POPs_ALS_occurrence$main$plot_adjusted_gam$Σchlordane, 
  results_POPs_ALS_occurrence$main$plot_copollutant_gam$Σchlordane, 
  nrow = 1)
wrap_plots(
  results_POPs_ALS_occurrence$main$plot_base_gam$ΣPBDE, 
  results_POPs_ALS_occurrence$main$plot_adjusted_gam$ΣPBDE, 
  results_POPs_ALS_occurrence$main$plot_copollutant_gam$ΣPBDE, 
  nrow = 1)
```

##### Sensitivity analysis POPs not summed

```{r, fig.height=6, fig.width=15}
#| column: screen-inset-right
#| echo: false
#| message: false
#| warning: false
wrap_plots(results_POPs_ALS_occurrence$sensitivity_not_summed$plot_adjusted_gam_not_summed[1:8], ncol = 4)
wrap_plots(results_POPs_ALS_occurrence$sensitivity_not_summed$plot_adjusted_gam_not_summed[9:16], ncol = 4)
wrap_plots(results_POPs_ALS_occurrence$sensitivity_not_summed$plot_adjusted_gam_not_summed[17:22], ncol = 4)
```

## Metanalysis (quartiles)

```{r fig.height=9, fig.width=9}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_occurrence$metanalysis$plot_metanalysis_quart
```

```{r}
#| echo: false
#| message: false
#| warning: false
extra_rows <- results_POPs_ALS_occurrence$metanalysis$metanalysis_quart |>
  distinct(explanatory) |> 
  mutate(
    term = "Quartile 1",
      "OR_base" = '-', "95%CI_base" = '-', "p-value_base" = '', "p-value_heterogeneity_base" = "", 
      "OR_adjusted" = '-', "95%CI_adjusted" = '-', "p-value_adjusted" = '', "p-value_heterogeneity_adjusted" = "", 
    "OR_copollutant" = '-', "95%CI_copollutant" = '-', "p-value_copollutant" = '', "p-value_heterogeneity_copollutant" = "")
    

table_S4 <- results_POPs_ALS_occurrence$metanalysis$metanalysis_quart |>
  select(model, explanatory, term, OR, `95%CI`, "p-value", 'p-value_heterogeneity') |>
  pivot_wider(
    names_from = model,  
    values_from = c("OR", "95%CI", "p-value", 'p-value_heterogeneity')) |>
  bind_rows(extra_rows) |>
  select(Exposures = explanatory, Quartiles = term,
         contains("base"), 
         contains("adjusted"), 
         contains("copollutant")) |>
  mutate(
    Exposures = gsub("OCP_", "", Exposures), 
    Exposures = fct_relevel(Exposures, "PCB_4", "PCB_DL", "PCB_NDL", "HCB", "ΣDDT", "β_HCH", "Σchlordane"),
    Exposures = fct_recode(Exposures, 
                          "Most prevalent PCBs" = "PCB_4",
                          "Dioxin-like PCBs" = "PCB_DL",
                          "Non-dioxin-like PCBs" = "PCB_NDL",
                          "β-HCH" = "β_HCH")) |>
  arrange(Exposures, Quartiles) 

table_S4 <- table_S4 |> 
  rename('OR' = 'OR_base', '95% CI' = '95%CI_base', 'p-value' = 'p-value_base', "Hetero-geneity test" = "p-value_heterogeneity_base",
         'OR ' = 'OR_adjusted', '95% CI ' = '95%CI_adjusted', 'p-value ' = 'p-value_adjusted', "Hetero-geneity test " = "p-value_heterogeneity_adjusted",
         ' OR ' = 'OR_copollutant', ' 95% CI ' = '95%CI_copollutant', ' p-value ' = 'p-value_copollutant', " Hetero-geneity test " = "p-value_heterogeneity_copollutant") |>
  flextable() |>
  add_footer_lines(
  "1POPs were summed as follows: Dioxin-like PCBs corresponds to PCBs 118 and 156; non-dioxin-like PCBs corresponds to PCBs 28, 52, 74, 99, 101, 138, 153, 170, 180, 183, 187; most prevalent PCBs corresponds to PCBs 118, 138, 153, 180; ΣDDT corresponds to p,p’-DDT and p,p’-DDE and finally Σchlordane corresponds to trans-nonanchlor and oxychlordane.
  2Base and adjusted models are conditional logistic regressions matched for sex and age, and for municipality and serum thawing history (Finnish cohorts). Adjusted models further account for smoking, BMI, serum total cholesterol, marital status, and education (except for FMC cohort for which education data was not available). Co-pollutant models further include all chemicals, where the chemical of interest is categorized into quartiles, while the others are treated as smooth terms in GAMs.
  3Estimated risk of ALS when exposures to POP are at quartiles 2, 3, and 4, compared to quartile 1.
  4CI: Confidence interval.
  5P-value of between-study heterogeneity (Cochran’s Q test).") |>
  add_header(
    "Exposures" = "Exposures", "Quartiles" = "Quartiles",
    "OR" = "Base model", "95% CI" = "Base model", "p-value" = "Base model", "Hetero-geneity test" = "Base model",
    "OR " = "Adjusted model", "95% CI " = "Adjusted model", "p-value " = "Adjusted model", "Hetero-geneity test " = "Adjusted model",
    " OR " = "Copollutant model", " 95% CI " = "Copollutant model", " p-value " = "Copollutant model", " Hetero-geneity test " = "Copollutant model") |>
  merge_h(part = "header") |>
  merge_v(j = "Exposures") |>
  theme_vanilla() |>
  bold(j = "Exposures", part = "body") |>
  align(align = "center", part = "all") |>
  align(j = "Exposures", align = "left", part = "all") |> 
  merge_at(j = "Exposures", part = "header") |>
  merge_at(j = "Quartiles", part = "header") |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all")|>
  set_table_properties(align = "left")
table_S4
rm(extra_rows, table_S4)
```

# POPs ans ALS survival

## Subjects characteristics (among cases only)

```{r}
#| echo: false
#| message: false
#| warning: false
#| paged-print: false
results_descriptive$comp$covar_comp_cases |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

## Danish cohort

### Effects of subject characteristics on ALS survival

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$danish$covar_danish |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### Effects of POPs on ALS survival

#### Continuous coding (standardized)

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$danish$POPs_sd_ALS_table_danish  |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$danish$POPs_sd_ALS_figure_danish
```

Checking for the copollutant model 
```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$danish$cheking_model3_cox_sd_danish
```


#### Quartiles

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$danish$POPs_quart_ALS_table_danish |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

```{r fig.height=9, fig.width=9}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$danish$POPs_quart_ALS_figure_danish
```

#### Cox-gam

```{r fig.height=9, fig.width=9}
#| echo: false
#| message: false
#| warning: false
wrap_plots(list(results_POPs_ALS_survival$danish$plot_base_cox_gam_danish$PCB_4, 
                results_POPs_ALS_survival$danish$plot_adjusted_cox_gam_danish$PCB_4, 
                wrap_elements(grid::nullGrob()),
                results_POPs_ALS_survival$danish$plot_base_cox_gam_danish$PCB_DL, 
                results_POPs_ALS_survival$danish$plot_adjusted_cox_gam_danish$PCB_DL, 
                results_POPs_ALS_survival$danish$plot_copollutant_cox_gam_danish$PCB_DL, 
                
                results_POPs_ALS_survival$danish$plot_base_cox_gam_danish$PCB_NDL, 
                results_POPs_ALS_survival$danish$plot_adjusted_cox_gam_danish$PCB_NDL, 
                results_POPs_ALS_survival$danish$plot_copollutant_cox_gam_danish$PCB_NDL, 
                
                results_POPs_ALS_survival$danish$plot_base_cox_gam_danish$OCP_HCB, 
                results_POPs_ALS_survival$danish$plot_adjusted_cox_gam_danish$OCP_HCB, 
                results_POPs_ALS_survival$danish$plot_copollutant_cox_gam_danish$OCP_HCB), 
           ncol = 3)

wrap_plots(list(results_POPs_ALS_survival$danish$plot_base_cox_gam_danish$ΣDDT, 
                results_POPs_ALS_survival$danish$plot_adjusted_cox_gam_danish$ΣDDT, 
                results_POPs_ALS_survival$danish$plot_copollutant_cox_gam_danish$ΣDDT, 
                
                results_POPs_ALS_survival$danish$plot_base_cox_gam_danish$OCP_β_HCH, 
                results_POPs_ALS_survival$danish$plot_adjusted_cox_gam_danish$OCP_β_HCH, 
                results_POPs_ALS_survival$danish$plot_copollutant_cox_gam_danish$OCP_β_HCH, 
                
                results_POPs_ALS_survival$danish$plot_base_cox_gam_danish$Σchlordane, 
                results_POPs_ALS_survival$danish$plot_adjusted_cox_gam_danish$Σchlordane, 
                results_POPs_ALS_survival$danish$plot_copollutant_cox_gam_danish$Σchlordane, 
                
                results_POPs_ALS_survival$danish$plot_base_cox_gam_danish$ΣPBDE, 
                results_POPs_ALS_survival$danish$plot_adjusted_cox_gam_danish$ΣPBDE, 
                results_POPs_ALS_survival$danish$plot_copollutant_cox_gam_danish$ΣPBDE), 
           ncol = 3)
```

#### q-gcomp analysis

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$danish$POPs_ALS_qgcomp_table_danish  |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
results_POPs_ALS_survival$danish$POPs_ALS_qgcomp_figure_danish
```

## Finnish cohorts

### Effects of subject characteristics on ALS survival

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$finnish$covar_ALS_table_finnish |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

### Effects of POPs on ALS survival

#### Continuous coding (standardized)

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$finnish$POPs_sd_ALS_table_finnish |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$finnish$POPs_sd_ALS_figure_finnish
```

#### Quartiles

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$finnish$POPs_quart_ALS_table_finnish |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

```{r, fig.height=9, fig.width=9}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$finnish$POPs_quart_ALS_figure_finnish
```

#### q-gcomp analysis

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$finnish$POPs_ALS_qgcomp_table_finnish  |>
  flextable() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
results_POPs_ALS_survival$finnish$POPs_ALS_qgcomp_figure_finnish
```

### Investigation of alternative Finnish models 
```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$finnish$investigation_finnish_models$investigation_finnish_models_table
```

```{r, fig.height=12, fig.width=12}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$finnish$investigation_finnish_models$investigation_finnish_models_figure
```


## Metanalysis

### Continuous coding (standardized)

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$metanalysis$POPs_sd_ALS_table_metanalysis |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$metanalysis$POPs_sd_ALS_figure_metanalysis
```

### Quartiles

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$metanalysis$POPs_quart_ALS_table_metanalysis |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

```{r, fig.height=9, fig.width=9}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$metanalysis$POPs_quart_ALS_figure_metanalysis
```

## Sensitivity analyses

```{r, fig.height=12, fig.width=12}
#| echo: false
#| message: false
#| warning: false
print(results_POPs_ALS_survival$sensi1$plot_justif)
```

```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$sensi1$sample_size_check
```

results not adjusted on the cohort
```{r, fig.width=12, fig.height=5}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$sensi1$POPs_sd_ALS_figure_sensi1_not_adjusted
```

results adjusted on the cohort
```{r, fig.width=12, fig.height=5}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$sensi1$POPs_sd_ALS_figure_sensi1_adjusted
```

results adjusted on the cohort (2 cat danish or finnish)
```{r, fig.width=12, fig.height=5}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$sensi1$POPs_sd_ALS_figure_sensi1_adjusted_2cat
```

Cohorte as an interaction term 
```{r}
#| echo: false
#| message: false
#| warning: false
results_POPs_ALS_survival$finnish$investigation_finnish_models$table_interaction
```

```{r}
#| echo: false
#| message: false
#| warning: false
corrplot(results_POPs_ALS_survival$sensi1$POPs_heatmap_cases_group, 
         method = 'color', 
         type = "lower", 
         tl.col = 'black', 
         tl.srt = 45, 
         addCoef.col = "black",
         number.cex = 0.8,
         number.digits = 1,
         tl.cex = 1,
         col = rev(COL2(diverging = "RdYlBu")))
```

# Fatty acids and ALS occurence

## Danish cohort

### Effects of subject characterist on ALS occurence in the Danish cohort

```{r}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_occurrence$danish$covar_als_table_danish  |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

### Effects of fatty acids on ALS occurence in the Danish cohort

#### Continuous coding (standardized)

```{r}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_occurrence$danish$fattyacids_sd_als_table_danish |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

```{r}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_occurrence$danish$fattyacids_sd_als_figure_danish
```

#### Quartiles

```{r}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_occurrence$danish$fattyacids_quart_als_table_danish |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

```{r, fig.height=12}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_occurrence$danish$fattyacids_quart_als_figure_danish
```

## Finnish cohorts

### Effects of subject characteristics on ALS occurence in the Finnish cohorts

```{r}
#| echo: false
#| message: false
#| warning: false

```

### Effects of fatty acids on ALS occurence in the Finnish cohorts

#### Continuous coding (standardized)

```{r}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_occurrence$finnish$fattyacids_sd_als_table_finnish |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

```{r}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_occurrence$finnish$fattyacids_sd_als_figure_finnish
```

#### Quartiles

```{r}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_occurrence$finnish$fattyacids_quart_als_table_finnish |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

```{r, fig.height=12}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_occurrence$finnish$fattyacids_quart_als_figure_finnish
```

### Sensitivity Ca

#### Continuous coding (standardized)

```{r}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_occurrence$sensi_ca$fattyacids_sd_als_table_sensi_ca_finnish 
results_fattyacids_ALS_occurrence$sensi_ca$fattyacids_sd_als_figure_sensi_ca_finnish
```

#### Quartiles

```{r}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_occurrence$sensi_ca$fattyacids_quart_als_table_sensi_ca_finnish 
```

```{r, fig.height=13}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_occurrence$sensi_ca$fattyacids_quart_als_figure_sensi_ca_finnish
```

# Fatty acids ans ALS survival

## Danish cohort

### Effects of covariates on ALS survival

```{r}
#| echo: false
#| message: true
#| warning: false
results_fattyacids_ALS_survival$danish$covar_danish |>
  as_flex_table() |>
  flextable::font(fontname = "Calibri", part = "all") |> 
  fontsize(size = 10, part = "all") |>
  padding(padding.top = 0, padding.bottom = 0, part = "all") |>
  set_table_properties(align = "left")
```

### Continuous coding (standardized)

```{r}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_survival$danish$fattyacids_sd_als_table_danish |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
results_fattyacids_ALS_survival$danish$fattyacids_sd_als_figure_danish
```

### Quartiles

```{r}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_survival$danish$fattyacids_quart_als_table_danish |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

```{r, fig.height=12}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_survival$danish$fattyacids_quart_als_figure_danish
```

```{r, fig.height=12, fig.width=12}
#| echo: false
#| message: false
#| warning: false
#| column: screen-inset-right
arrange_ggsurvplots(
  results_fattyacids_ALS_survival$danish$survival_plots_danish[1:4],
  ncol = 2,              
  nrow = 2)
```

## Finnish cohorts

### Effects of covariates on ALS survival

To be done

```{r}
#| echo: false
#| message: true
#| warning: false
```

### Continuous coding (standardized)

```{r}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_survival$finnish$fattyacids_sd_als_table_finnish |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
results_fattyacids_ALS_survival$finnish$fattyacids_sd_als_figure_finnish
```

### Quartiles

```{r}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_survival$finnish$fattyacids_quart_als_table_finnish |>
  set_table_properties(width = 1, layout = "autofit", align = "left")
```

```{r, fig.height=12}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_survival$finnish$fattyacids_quart_als_figure_finnish
```

## Comparison of the results

```{r, fig.height=10}
#| echo: false
#| message: false
#| warning: false
results_fattyacids_ALS_survival$main_analysis$main_results_fattyacids_ALS_survival |>
  filter(term == "Continuous") |>
  mutate(model = fct_recode(model, 
                            "Base model" = "base",
                            "Adjusted model" = "adjusted"),
         model = fct_relevel(model, 'Base model', 'Adjusted model'), 
         explanatory = factor(explanatory, levels = fattyacids_labels),
         explanatory = fct_rev(explanatory),
         explanatory = fct_recode(explanatory, !!!fattyacids_labels)) |>
  arrange(explanatory) |> 
  ggplot(aes(x = explanatory, y = HR, ymin = lower_CI, ymax = upper_CI, color = `p-value_shape`, shape = study)) +
  geom_pointrange(position = position_dodge(width = 0.6), size = 0.5) + 
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") +  
  facet_grid(cols = dplyr::vars(model), switch = "y", scales = "free_x") +  
  scale_color_manual(values = c("p-value<0.05" = "red", "p-value≥0.05" = "black")) +
  labs(x = "PUFAs", y = "Hazard Ratio (HR)", color = "p-value") +
  theme_lucid() +
  theme(strip.text = element_text(face = "bold"), 
        legend.position = "bottom", 
        strip.text.y = element_text(hjust = 0.5)) +
  coord_flip()

```
